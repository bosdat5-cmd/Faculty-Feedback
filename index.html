<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>THE INSTITUTE OF CHARTERED ACCOUNTANTS OF INDIA</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0077b6, #00b4d8);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: #fff;
      margin-top: 40px;
      padding: 30px;
      border-radius: 15px;
      width: 500px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      animation: fadeIn 0.5s ease-in-out;
    }
    h2 {
      text-align: center;
      color: #023e8a;
      margin-bottom: 20px;
      font-weight: 600;
    }
    h3 {
      color: #0077b6;
      margin-bottom: 15px;
    }
    label {
      font-weight: 500;
      display: block;
      margin: 8px 0 5px;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    input:focus, select:focus {
      border-color: #00b4d8;
      box-shadow: 0 0 6px rgba(0,180,216,0.5);
    }
    .btn {
      display: inline-block;
      background: #0077b6;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin: 5px 5px 0 0;
      transition: all 0.3s;
    }
    .btn:hover {
      background: #023e8a;
      transform: scale(1.05);
    }
    .form-page { display: none; }
    .active-page { display: block; }
    .quote-box {
      background: #f1faff;
      padding: 20px;
      border-left: 5px solid #00b4d8;
      margin-top: 20px;
      border-radius: 10px;
      font-style: italic;
      color: #333;
    }
    .thankyou {
      text-align: center;
      color: #023e8a;
      font-size: 18px;
      font-weight: 600;
      margin-top: 10px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<div class="container">

  <!-- âœ… Page 1: Enter Email -->
  <div id="page1" class="form-page active-page">
    <h2>Student Feedback Form</h2>
    <label for="emailId">Enter Email ID</label>
    <input type="email" id="emailId" placeholder="Enter your email" required>
    <button class="btn" onclick="saveEmail()">Next</button>
  </div>

  <!-- âœ… Page 2: Select Day & SRN -->
  <div id="page2" class="form-page">
    <h2>Select Day & SRN</h2>

    <label for="daySelect">Select Day</label>
    <select id="daySelect">
      <option value="">-- Select Day --</option>
      <option value="Day 1">Day 1</option>
      <option value="Day 2">Day 2</option>
      <option value="Day 3">Day 3</option>
    </select>

    <label for="srnSelect">Select SRN</label>
    <select id="srnSelect">
      <option value="">-- Select SRN --</option>
    </select>

    <input type="file" accept=".xlsx,.xls" onchange="handleFileUpload(event)" />
    <button class="btn" onclick="downloadTemplate()">Download Template</button>
    <br><br>
    <button class="btn" onclick="goToPage(1)">Back</button>
    <button class="btn" onclick="saveDaySRN()">Next</button>
  </div>

  <!-- âœ… Page 3: Submit Feedback -->
  <div id="page3" class="form-page">
    <h2>Submit Feedback</h2>
    <div class="quote-box">
      Please confirm your selection and submit your feedback.
    </div>
    <br>
    <button id="submitBtn" class="btn" onclick="finalizeGrade()">Submit</button>
    <button class="btn" onclick="goToPage(2)">Back</button>
  </div>

  <!-- âœ… Page 4: Thank You -->
  <div id="page4" class="form-page">
    <h2>Thank You ðŸŽ‰</h2>
    <p class="thankyou">Your feedback has been submitted successfully.</p>
    <button class="btn" onclick="goToPage(1)">Start Again</button>
  </div>

</div>

<script>
  let allSRNs = [];    // store original SRNs from Excel
  let usedSRNs = [];   // store submitted SRNs

  // âœ… Go to specific page
  function goToPage(pageNumber) {
    document.querySelectorAll(".form-page").forEach(page => page.classList.remove("active-page"));
    document.getElementById("page" + pageNumber).classList.add("active-page");
  }

  // âœ… Save Email (Page 1)
  function saveEmail() {
    const email = document.getElementById("emailId").value.trim();
    if (!email) {
      alert("âš  Please enter your Email ID");
      return;
    }
    sessionStorage.setItem("userEmail", email);
    goToPage(2);
  }

  // âœ… Save Day & SRN (Page 2)
  function saveDaySRN() {
    const day = document.getElementById("daySelect").value;
    const srn = document.getElementById("srnSelect").value;
    const email = sessionStorage.getItem("userEmail");

    if (!day || !srn) {
      alert("âš  Please select both Day and SRN");
      return;
    }

    let emailData = JSON.parse(localStorage.getItem(email)) || { completedDays: [] };

    if (emailData.completedDays.length >= 2) {
      alert("âš  This email has already submitted feedback for 2 days.");
      return;
    }
    if (emailData.completedDays.includes(day)) {
      alert(`âš  You already submitted feedback for ${day}.`);
      return;
    }

    sessionStorage.setItem("selectedDay", day);
    sessionStorage.setItem("selectedSRN", srn);

    goToPage(3);
  }

  // âœ… Final Submission (Page 3)
  function finalizeGrade() {
    const srn = sessionStorage.getItem("selectedSRN");
    const day = sessionStorage.getItem("selectedDay");
    const email = sessionStorage.getItem("userEmail");

    if (!srn || !day || !email) {
      alert("âš  Missing data, please restart the form.");
      return;
    }

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.innerHTML = "â³ Submitting...";
    submitBtn.disabled = true;

    setTimeout(() => {
      let emailData = JSON.parse(localStorage.getItem(email)) || { completedDays: [] };
      if (!emailData.completedDays.includes(day)) {
        emailData.completedDays.push(day);
        localStorage.setItem(email, JSON.stringify(emailData));
      }

      const srnSelect = document.getElementById("srnSelect");
      for (let i = 0; i < srnSelect.options.length; i++) {
        if (srnSelect.options[i].value === srn) {
          srnSelect.remove(i);
          break;
        }
      }

      submitBtn.innerHTML = "âœ… Submitted";
      submitBtn.disabled = false;

      if (srnSelect.options.length > 1) {
        goToPage(2);
      } else {
        if (emailData.completedDays.length >= 2) {
          goToPage(4);
        } else {
          goToPage(2);
        }
      }
    }, 1000);
  }

  // âœ… Download Excel Template
  function downloadTemplate() {
    const wb = XLSX.utils.book_new();
    const wsData = [["S.No", "SRN", "Name"]];
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "Student_Template.xlsx");
  }

  // âœ… Handle Excel Upload
  function handleFileUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      allSRNs = [];
      for (let i = 1; i < jsonData.length; i++) {
        if (jsonData[i][1]) allSRNs.push(jsonData[i][1]);
      }

      populateSRNDropdown();
      alert("âœ… Student SRNs loaded successfully!");
    };
    reader.readAsArrayBuffer(file);
  }

  // âœ… Populate SRN Dropdown
  function populateSRNDropdown() {
    const dropdown = document.getElementById("srnSelect");
    dropdown.innerHTML = '<option value="">-- Select SRN --</option>';
    allSRNs.forEach(srn => {
      if (!usedSRNs.includes(srn)) {
        const opt = document.createElement("option");
        opt.value = srn;
        opt.textContent = srn;
        dropdown.appendChild(opt);
      }
    });
  }
</script>

</body>
</html>
