<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Feedback Form</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0077b6, #00b4d8); margin:0; padding:0; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
.container { background:#fff; margin-top:40px; padding:30px; border-radius:15px; width:500px; box-shadow:0 6px 20px rgba(0,0,0,0.15); animation:fadeIn 0.5s ease-in-out; }
h2 { text-align:center; color:#023e8a; margin-bottom:20px; font-weight:600; }
h3 { color:#0077b6; margin-bottom:15px; }
label { font-weight:500; display:block; margin:8px 0 5px; color:#333; }
input, select { width:100%; padding:10px; border:1px solid #ccc; border-radius:10px; outline:none; font-size:14px; margin-bottom:15px; transition:all 0.3s; }
input:focus, select:focus { border-color:#00b4d8; box-shadow:0 0 6px rgba(0,180,216,0.5); }
.btn { display:inline-block; background:#0077b6; color:#fff; border:none; border-radius:10px; padding:10px 18px; font-size:14px; font-weight:500; cursor:pointer; margin:5px 5px 0 0; transition:all 0.3s; }
.btn:hover { background:#023e8a; transform:scale(1.05); }
.form-page { display:none; }
.active-page { display:block; }
.quote-box { background:#f1faff; padding:20px; border-left:5px solid #00b4d8; margin-top:20px; border-radius:10px; font-style:italic; color:#333; }
@keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
</style>
</head>
<body>
<div class="container">
  <h2>THE INSTITUTE OF CHARTERED ACCOUNTANTS OF INDIA</h2>
  <h3 style="text-align:center; color:#0077b6;">Faculty Feedback Form</h3>

  <!-- Page 1 -->
  <div class="form-page active-page" id="page1">
    <h3>Basic Details</h3>
    <label>Faculty Name:</label>
    <input type="text" id="facultyName" placeholder="Enter faculty name" required>
    <label>Mobile Number:</label>
    <input type="text" id="mobileNumber" placeholder="10-digit mobile" required>
    <label>Email ID:</label>
    <input type="email" id="emailId" placeholder="example@email.com" required>
    <label>Batch ID:</label>
    <input type="text" id="batchId" placeholder="Enter batch ID" required>
    <label>Region:</label>
    <select id="regionSelect" required onchange="updateBranches()">
      <option value="">-- Select Region --</option>
      <option value="CIRC">CIRC</option>
      <option value="EIRC">EIRC</option>
      <option value="NIRC">NIRC</option>
      <option value="SIRC">SIRC</option>
      <option value="WIRC">WIRC</option>
      <option value="FRO">FRO</option>
    </select>

    <label>Branches:</label>
    <select id="branchSelect" required>
      <option value="">-- Select Branch --</option>
    </select>

    <h3>Select Day for Feedback</h3>
    <label>Day:</label>
    <select id="lockDaySelect" required>
      <option value="">-- Select Day --</option>
    </select>

    <h3>Student Data</h3>
    <button class="btn" onclick="downloadTemplate()">ðŸ“¥ Download Excel Template</button>
    <label>Upload Student Data File:</label>
    <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="handleFileUpload(event)">

    <button class="btn" onclick="startFeedback()">âž¡ Start Feedback</button>
  </div>

  <!-- Page 2 -->
  <div class="form-page" id="page2">
    <h3>Session Feedback</h3>
    <label>Day:</label>
    <select id="daySelect" disabled></select>

    <label>Student Unique Key (SRN):</label>
    <select id="uniqueKeySelect">
      <option value="">-- Select SRN --</option>
    </select>

    <button class="btn" onclick="showPage(1)">â¬… Back</button>
    <button class="btn" onclick="startSRNFeedback()">âœ… Next</button>
  </div>

  <!-- Page 3 -->
  <div class="form-page" id="page3">
    <h2 id="feedbackHeading" class="text-xl font-semibold mb-4 text-center">Feedback Questions</h2>
    <div id="questionsContainer"></div>
    <div id="resultBox" class="mt-6 p-4 border rounded bg-gray-100">
      <p>Score: <span id="finalScore">0</span></p>
      <p>Grade: <span id="finalGrade">-</span></p>
    </div>
    <button class="btn" onclick="prevPage3()">â¬… Previous SRN</button>
    <button class="btn" onclick="submitFeedback()">Submit Feedback</button>
  </div>

  <!-- Page 4 -->
  <div class="form-page" id="page4">
    <div class="text-center p-6">
      <h2>Thank You!</h2>
      <p>Your feedback has been successfully submitted.</p>
      <div class="quote-box">
        <p id="dailyQuote"></p>
      </div>
    </div>
  </div>
</div>

<script>
const webAppURL = "YOUR_DEPLOYED_APP_SCRIPT_URL_HERE"; // ðŸ”¹ replace with your deployed web app URL

let currentPage = 1;
let srnListGlobal = [];
let lockedDay = "";
let currentSRNIndex = 0;

const questions = [
  "Subject knowledge","Session planning & structure","Communication skills",
  "Engagement & interaction","Innovative methods","Time management",
  "Adherence to guidelines","Response to questions","Practical examples",
  "Professional conduct","Technology use","Discipline",
  "Student feedback","Contribution to growth","Overall impact"
];

const branchesMap = {
  "CIRC":["Agra","Ajmer","Aligarh","Alwar","Bareilly","Beawar","Bhagalpur","Bharatpur","Bhilai","Bhilwara","Bhopal","Bikaner","Bilaspur","Bulandshahr","Chittorgarh","Darbhanga","Dehradun","Dhanbad","Gautam Budh Nagar","Ghaziabad","Gorakhpur","Gwalior","Haldwani","Hanumangarh","Haridwar","Indore","Jabalpur","Jaipur","Jamshedpur","Jhansi","Jodhpur","Kishangarh","Kota","Lucknow","Mandsaur","Mathura","Meerut","Moradabad","Muzaffarnagar","Muzaffarpur","Neemuch","Pali","Patna","Prayagraj","Raigarh","Raipur","Rajsamand","Ranchi","Ratlam","Saharanpur","Satna","Sikar","Sriganganagar","Tonk","Udaipur","Ujjain","Varanasi"],
  "EIRC":["Asansol","Bhubaneswar","Brahmapur","Cuttack","Dibrugarh","Durgapur","Guwahati","Jharsuguda","Raniganj","Rourkela","Sambalpur","Siliguri","Tinsukia"],
  "NIRC":["Ambala","Amritsar","Bahadurgarh","Bathinda","Bhiwani","Chandigarh","Faridabad","Gurugram","Himachal Pradesh","Hisar","Jalandhar","Jammu And Kashmir","Kaithal","Karnal","Kurukshetra","Ludhiana","Mandi Gobindgarh","Panipat","Patiala","Rewari","Rohtak","Sangrur","Sirsa","Sonepat","Yamunanagar"],
  "SIRC":["Alappuzha","Anantapur","Ballari","Belagavi","Bengaluru","Chengalpattu","Coimbatore","Ernakulam","Erode","Guntur","Hubballi","Hyderabad","Kadapa","Kakinada","Kalaburagi","Kannur","Karimnagar","Kollam","Kottayam","Kozhikode","Kumbakonam","Kurnool","Madurai","Mangaluru","Mysuru","Nellore","Ongole","Palakkad","Puducherry","Rajamahendravaram","Salem","Sivakasi","Thiruvananthapuram","Thoothukudi","Thrissur","Tiruchirapalli","Tirunelveli","Tirupati","Tirupur","Udupi","Vellore","Vijayawada","Visakhapatnam","Vizianagaram","Warangal","West Godavari"],
  "WIRC":["Ahmedabad","Ahmednagar","Akola","Amravati","Anand","Bharuch","Bhavnagar","Bhuj","Chhatrapati Sambhajinagar (Aurangabad)","Dhule","Gandhidham","Gandhinagar","Goa","Ichalkaranji","Jalgaon","Jamnagar","Kalyan Dombivli","Kolhapur","Latur","Nagpur","Nanded","Nashik","Navi Mumbai","Navsari","Pimpri Chinchwad","Pune","Rajkot","Ratnagiri","Sangli","Satara","Solapur","Surat","Thane","Vadodara","Vapi","Vasai"],
  "FRO":["Dubai"]
};

// --- Populate branches ---
function updateBranches() {
  const region = document.getElementById("regionSelect").value;
  const branchSelect = document.getElementById("branchSelect");
  branchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
  if(branchesMap[region]){
    branchesMap[region].forEach(branch=>{
      const opt=document.createElement("option");
      opt.value=branch;
      opt.textContent=branch;
      branchSelect.appendChild(opt);
    });
  }
}

// --- Populate day dropdown ---
function populateDayDropdown(){
  const daySelect=document.getElementById("lockDaySelect");
  for(let i=1;i<=15;i++){
    const opt=document.createElement("option");
    opt.value=i;
    opt.textContent="Day "+i;
    daySelect.appendChild(opt);
  }
}

// --- Render Questions ---
function renderQuestions(){
  const container=document.getElementById("questionsContainer");
  container.innerHTML="";
  questions.forEach((q,i)=>{
    const block=document.createElement("div");
    block.innerHTML=`<label>${i+1}. ${q}</label>
    <select class="ratingSelect" required>
      <option value="">-- Select Rating --</option>
      <option value="20">1 - Poor</option>
      <option value="40">2 - Below Average</option>
      <option value="60">3 - Average</option>
      <option value="80">4 - Good</option>
      <option value="100">5 - Excellent</option>
    </select>`;
    container.appendChild(block);
  });
  document.querySelectorAll(".ratingSelect").forEach(sel=>sel.addEventListener("change",updateLiveScore));
}

// --- Live Score & Grade ---
function updateLiveScore(){
  const selects=document.querySelectorAll(".ratingSelect");
  let total=0,count=0;
  selects.forEach(sel=>{if(sel.value){total+=parseInt(sel.value);count++;}});
  const avg=count?total/count:0;
  document.getElementById("finalScore").innerText=avg.toFixed(2);
  let grade="-";
  if(avg>=85) grade="A+"; else if(avg>=70) grade="A"; else if(avg>=50) grade="B+"; else if(avg>=30) grade="B"; else if(avg>0) grade="C";
  document.getElementById("finalGrade").innerText=grade;
}

// --- Download Excel Template ---
function downloadTemplate(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([["S.No","SRN","Name"]]);
  XLSX.utils.book_append_sheet(wb,ws,"Template");
  XLSX.writeFile(wb,"Student_Template.xlsx");
}

// --- Handle Excel Upload ---
function handleFileUpload(event){
  const file=event.target.files[0];
  const reader=new FileReader();
  reader.onload=function(e){
    const data=new Uint8Array(e.target.result);
    const workbook=XLSX.read(data,{type:"array"});
    const sheet=workbook.Sheets[workbook.SheetNames[0]];
    const jsonData=XLSX.utils.sheet_to_json(sheet,{header:1});
    srnListGlobal=[];
    for(let i=1;i<jsonData.length;i++){
      if(jsonData[i][1]){
        srnListGlobal.push({value:jsonData[i][1].toString().trim(),completed:false});
      }
    }
    alert("âœ… Student SRNs loaded!");
  }
  reader.readAsArrayBuffer(file);
}

// --- Lock Day ---
function lockDayForPages(selectedDay){
  lockedDay = selectedDay;
  document.getElementById("lockDaySelect").value = lockedDay;
  document.getElementById("lockDaySelect").disabled = true;
  document.getElementById("daySelect").innerHTML = `<option value="${lockedDay}">Day ${lockedDay}</option>`;
  document.getElementById("daySelect").disabled = true;
}

// --- Update SRNs ---
function updateSRNsForPage2(){
  const srnSelect=document.getElementById("uniqueKeySelect");
  srnSelect.innerHTML='<option value="">-- Select SRN --</option>';
  srnListGlobal.forEach(srnObj=>{
    if(!srnObj.completed){
      const opt=document.createElement("option");
      opt.value=srnObj.value;
      opt.textContent=srnObj.value;
      srnSelect.appendChild(opt);
    }
  });
}

// --- Start Feedback ---
function startFeedback(){
  if(!srnListGlobal.length){alert("Upload student data first");return;}
  const selectedDay=document.getElementById("lockDaySelect").value;
  if(!selectedDay && !lockedDay){alert("Select a day");return;}
  lockDayForPages(selectedDay);
  updateSRNsForPage2();
  showPage(2);
}

// --- Start SRN Feedback ---
function startSRNFeedback(){
  const srnSelect=document.getElementById("uniqueKeySelect").value;
  if(!srnSelect){alert("Select a SRN to continue");return;}
  currentSRNIndex=srnListGlobal.findIndex(s=>s.value===srnSelect);
  loadSRN(currentSRNIndex);
  showPage(3);
}

// --- Load SRN ---
function loadSRN(index){
  if(srnListGlobal[index]){
    document.getElementById("feedbackHeading").innerText=`Feedback Questions - SRN: ${srnListGlobal[index].value}`;
    document.querySelectorAll(".ratingSelect").forEach(sel=>sel.value="");
    updateLiveScore();
  }
}

// --- Submit Feedback (Fully Working) ---
async function submitFeedback(){
  const srnObj = srnListGlobal[currentSRNIndex];
  if(!srnObj) return;

  const selects = document.querySelectorAll(".ratingSelect");
  for(let sel of selects){
    if(!sel.value){ alert("Please rate all questions"); return; }
  }

  const payload = {
    facultyName: document.getElementById("facultyName").value.trim(),
    mobile: document.getElementById("mobileNumber").value.trim(),
    email: document.getElementById("emailId").value.trim(),
    batchId: document.getElementById("batchId").value.trim(),
    region: document.getElementById("regionSelect").value,
    branch: document.getElementById("branchSelect").value,
    day: lockedDay,
    srn: srnObj.value,
    ratings: Array.from(selects).map(s => s.value),
    score: document.getElementById("finalScore").innerText,
    grade: document.getElementById("finalGrade").innerText
  };

  try {
    const response = await fetch(webAppURL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const result = await response.json();

    if(result.status === "success"){
      srnObj.completed = true;
      const remaining = srnListGlobal.filter(s => !s.completed);
      if(remaining.length > 0){
        updateSRNsForPage2();
        const nextIndex = srnListGlobal.findIndex(s => !s.completed);
        currentSRNIndex = nextIndex;
        loadSRN(currentSRNIndex);
        alert("âœ… Feedback submitted! Next SRN loaded.");
        showPage(2);
      } else {
        showPage(4);
        showDailyQuote();
      }
    } else {
      alert("Error: " + result.message);
    }
  } catch(err){
    alert("Submission failed: " + err.message);
  }
}

// --- Previous SRN ---
function prevPage3(){
  const prevIndex=srnListGlobal.slice(0,currentSRNIndex).reverse().findIndex(s=>s.completed);
  if(prevIndex===-1){alert("No previous SRN"); return;}
  currentSRNIndex=currentSRNIndex-prevIndex-1;
  loadSRN(currentSRNIndex);
}

// --- Show Page ---
function showPage(pageNum){
  document.querySelectorAll(".form-page").forEach(p=>p.classList.remove("active-page"));
  document.getElementById("page"+pageNum).classList.add("active-page");
  currentPage=pageNum;
}

// --- Daily Quote ---
function showDailyQuote(){
  const quotes=[
    "Success is not final, failure is not fatal: it is the courage to continue that counts.",
    "The best way to predict the future is to create it.",
    "Dream big. Start small. Act now.",
    "Believe you can and you're halfway there.",
    "Push yourself, because no one else is going to do it for you.",
    "Great things never come from comfort zones."
  ];
  const today=new Date().getDate();
  document.getElementById("dailyQuote").innerText=quotes[today%quotes.length];
}

// --- Initialize ---
document.addEventListener("DOMContentLoaded", () => {
  renderQuestions();
  populateDayDropdown();
  updateBranches();
});
</script>
</body>
</html>

